<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>MediaBox AI Dashboard</title>
  
  <!-- Responsive Design System -->
  <link rel="stylesheet" href="responsive.css">
  
  <style>
    @import url('https://fonts.googleapis.com/css2?family=Roboto:wght@300;500;700&display=swap');

    * {
      margin: 0;
      padding: 0;
      box-sizing: border-box;
    }

    /* ========== 4K/8K TV RESPONSIVE SCALING ========== */
    html {
      font-size: 14px; /* Base for 1080p */
    }

    /* 4K (3840x2160) - 200% scaling */
    @media (min-width: 3840px) {
      html {
        font-size: 32px;
      }
    }

    /* 8K (7680x4320) - 400% scaling */
    @media (min-width: 7680px) {
      html {
        font-size: 64px;
      }
    }

    body {
      font-family: 'Roboto', sans-serif;
      background: linear-gradient(135deg, #0a1929, #1a237e, #0d47a1, #1565c0);
      background-size: 100% 100%;
      min-height: 100vh;
      height: 100vh;
      display: flex;
      flex-direction: column;
      justify-content: center;
      align-items: center;
      color: #fff;
      padding: 20px;
      overflow: hidden;
      position: relative;
      /* Better text readability for TV viewing */
      text-shadow: 2px 2px 4px rgba(0, 0, 0, 0.8);
    }

    /* Background Theme Variations */
    body.theme-blue {
      background: linear-gradient(135deg, #0a1929, #1a237e, #0d47a1, #1565c0);
    }

    body.theme-black {
      background: linear-gradient(135deg, #000000, #1a1a1a, #0a0a0a, #2d2d2d);
    }

    body.theme-grey {
      background: linear-gradient(135deg, #1c1c1c, #2d2d2d, #3a3a3a, #505050);
    }

    body.theme-purple {
      background: linear-gradient(135deg, #1a0033, #2d1b69, #5a189a, #7209b7);
    }

    body.theme-teal {
      background: linear-gradient(135deg, #003d3d, #006666, #008b8b, #20b2aa);
    }


    /* Static Wave Shapes */
    body::before,
    body::after {
      content: '';
      position: fixed;
      filter: blur(100px);
      opacity: 0.2;
      z-index: 0;
    }

    body::before {
      width: 1200px;
      height: 600px;
      background: linear-gradient(90deg, #1e88e5 0%, #42a5f5 50%, #64b5f6 100%);
      top: -200px;
      left: -400px;
      border-radius: 40%;
    }

    body::after {
      width: 1400px;
      height: 700px;
      background: linear-gradient(90deg, #0d47a1 0%, #1565c0 50%, #1976d2 100%);
      bottom: -250px;
      right: -500px;
      border-radius: 45%;
    }


    .shape {
      position: fixed;
      filter: blur(80px);
      opacity: 0.15;
      z-index: 0;
    }

    .shape1 {
      width: 600px;
      height: 400px;
      background: linear-gradient(120deg, #29b6f6 0%, #0277bd 100%);
      top: 15%;
      right: 5%;
      border-radius: 50% 40% 60% 50%;
    }

    .shape2 {
      width: 700px;
      height: 500px;
      background: linear-gradient(45deg, #039be5 0%, #01579b 100%);
      bottom: 5%;
      left: -100px;
      border-radius: 60% 50% 40% 60%;
    }

    .shape3 {
      width: 500px;
      height: 500px;
      background: linear-gradient(90deg, #4fc3f7 0%, #0288d1 50%, #01579b 100%);
      top: 45%;
      left: 40%;
      border-radius: 40% 60% 50% 40%;
    }

    .container {
      width: 100%;
      max-width: 1920px;
      height: 100%;
      position: relative;
      z-index: 1;
    }

    .glass-panel {
      background: rgba(255, 255, 255, 0.08);
      box-shadow: 0 8px 32px 0 rgba(31, 38, 135, 0.37);
      backdrop-filter: blur(15px);
      -webkit-backdrop-filter: blur(15px);
      border-radius: 20px;
      border: 1px solid rgba(255, 255, 255, 0.1);
      padding: 30px;
      text-align: center;
      height: 100%;
      display: flex;
      flex-direction: column;
      overflow: hidden;
    }

    .header {
      display: flex;
      justify-content: space-between;
      align-items: center;
      margin-bottom: 30px;
      flex-wrap: wrap;
      gap: 15px;
    }

    .header-left,
    .header-right {
      flex: 1;
      display: flex;
      align-items: center;
      gap: 20px;
    }

    .header-left {
      justify-content: flex-start;
    }

    .header-right {
      justify-content: flex-end;
    }

    .pip-toggle-btn {
      background: rgba(30, 136, 229, 0.3);
      border: 1px solid rgba(30, 136, 229, 0.5);
      color: #42a5f5;
      padding: 8px 16px;
      border-radius: 8px;
      font-size: 0.9em;
      font-weight: 600;
      cursor: pointer;
      white-space: nowrap;
      transition: all 0.3s ease;
      display: flex;
      align-items: center;
      gap: 8px;
    }

    .pip-toggle-btn:hover {
      background: rgba(30, 136, 229, 0.4);
      border-color: rgba(30, 136, 229, 0.7);
      transform: translateY(-2px);
    }

    .pip-toggle-btn.active {
      background: rgba(76, 175, 80, 0.3);
      border-color: rgba(76, 175, 80, 0.5);
      color: #66bb6a;
    }

    .pip-toggle-btn.hidden {
      display: none;
    }

    .header-info-item {
      display: flex;
      align-items: center;
      gap: 12px;
    }

    .header-info-icon {
      font-size: 2em;
      filter: drop-shadow(0 2px 4px rgba(0, 0, 0, 0.3));
    }

    .header-info-main {
      font-size: 1.4em;
      font-weight: 700;
      line-height: 1;
    }

    .header-info-sub {
      font-size: 0.85em;
      opacity: 0.8;
      line-height: 1;
    }

    .logo-title {
      display: flex;
      align-items: center;
      gap: 20px;
      flex: 1;
      justify-content: flex-start;
    }

    .logo {
      height: 60px;
      width: auto;
      filter: drop-shadow(0 4px 8px rgba(0, 0, 0, 0.3));
      transition: transform 0.3s ease;
    }

    .app-link {
      display: flex;
      align-items: center;
      gap: 20px;
      color: inherit;
      text-decoration: none;
    }
    .app-link:hover h1 { text-decoration: underline; }

    .logo:hover {
      transform: scale(1.05);
    }

    h1 {
      font-weight: 700;
      font-size: 2.2em;
      text-shadow: 2px 2px 4px rgba(0,0,0,0.3);
      margin: 0;
      background: linear-gradient(135deg, #ffffff 0%, #a8daff 100%);
      -webkit-background-clip: text;
      -webkit-text-fill-color: transparent;
      background-clip: text;
    }


    .mode-toggle {
      background: rgba(255, 255, 255, 0.1);
      border: 1px solid rgba(255, 255, 255, 0.2);
      border-radius: 10px;
      padding: 8px 15px;
      display: flex;
      align-items: center;
      gap: 10px;
      font-size: 0.8em;
      cursor: pointer;
      transition: all 0.3s ease;
    }

    .mode-toggle:hover {
      background: rgba(255, 255, 255, 0.15);
    }

    .toggle-switch {
      position: relative;
      width: 50px;
      height: 26px;
      background: rgba(255, 255, 255, 0.2);
      border-radius: 13px;
      cursor: pointer;
      transition: background 0.3s ease;
    }

    .toggle-switch.active {
      background: rgba(100, 255, 100, 0.3);
    }

    .toggle-slider {
      position: absolute;
      top: 3px;
      left: 3px;
      width: 20px;
      height: 20px;
      background: white;
      border-radius: 50%;
      transition: transform 0.3s ease;
    }

    .toggle-switch.active .toggle-slider {
      transform: translateX(24px);
    }

    .build-number {
      padding: 8px 16px;
      border-radius: 8px;
      background: rgba(30, 136, 229, 0.3);
      border: 1px solid rgba(30, 136, 229, 0.5);
      font-size: 0.9em;
      font-weight: 600;
      color: #42a5f5;
      white-space: nowrap;
    }

    .resolution-display {
      display: flex;
      align-items: center;
      gap: 8px;
      padding: 8px 16px;
      border-radius: 8px;
      background: rgba(76, 175, 80, 0.3);
      border: 1px solid rgba(76, 175, 80, 0.5);
      font-size: 0.9em;
      font-weight: 600;
      color: #66bb6a;
      white-space: nowrap;
      transition: all 0.3s ease;
    }

    .resolution-display:hover {
      background: rgba(76, 175, 80, 0.4);
      border-color: rgba(76, 175, 80, 0.7);
      transform: translateY(-2px);
    }

    .resolution-icon {
      font-size: 1.1em;
    }

    .resolution-text {
      font-family: 'Courier New', monospace;
      font-weight: 700;
      letter-spacing: 0.5px;
    }

    .status-message {
      padding: 12px 20px;
      border-radius: 10px;
      background: rgba(0, 0, 0, 0.3);
      border: 1px solid rgba(255, 255, 255, 0.2);
      font-size: 1em;
      min-width: 150px;
      display: flex;
      align-items: center;
      justify-content: center;
      font-weight: 500;
    }

    .main-content {
      display: flex;
      flex-direction: row;
      gap: 20px;
      height: calc(100vh - 250px); /* Full height minus header */
      overflow: hidden; /* Prevent entire screen scrolling */
    }

    /* Responsive: Stack on small screens */
    @media (max-width: 900px) {
      .main-content {
        flex-direction: column;
        gap: 10px;
        height: auto;
      }
    }

    .services-section {
      display: flex;
      flex-direction: column;
      gap: 10px;
      width: 400px; /* Fixed width for services panel */
      min-width: 400px; /* Prevent shrinking */
      max-width: 400px; /* Prevent growing */
      background: rgba(0, 0, 0, 0.85);
      padding: 25px;
      border-radius: 20px;
      border: 1px solid rgba(255, 255, 255, 0.1);
      height: 100%;
      overflow-y: auto;
      overflow-x: hidden;
    }
    
    /* Responsive: Full width on small screens */
    @media (max-width: 900px) {
      .services-section {
        width: 100%;
        min-width: 100%;
        max-width: 100%;
        height: auto;
        max-height: 50vh;
      }
    }
    
    /* Smooth scrolling for services panel */
    .services-section::-webkit-scrollbar {
      width: 10px;
    }
    
    .services-section::-webkit-scrollbar-track {
      background: rgba(255, 255, 255, 0.05);
      border-radius: 10px;
    }
    
    .services-section::-webkit-scrollbar-thumb {
      background: rgba(255, 255, 255, 0.2);
      border-radius: 10px;
    }
    
    .services-section::-webkit-scrollbar-thumb:hover {
      background: rgba(255, 255, 255, 0.3);
    }

    /* ========== PiP PREVIEW SECTION ========== */
    .pip-preview-section {
      background: rgba(0, 0, 0, 0.6);
      border-radius: 10px;
      padding: 12px;
      border: 1px solid rgba(255, 255, 255, 0.1);
      display: flex;
      flex-direction: column;
      flex: 1; /* Stretch to fill available space */
      min-height: 0; /* Allow flex shrinking */
      overflow: hidden;
    }

    /* Hide preview section in browser mode */
    .pip-preview-section.browser-mode {
      display: none;
    }
    
    /* Responsive: Full width on small screens */
    @media (max-width: 900px) {
      .pip-preview-section {
        width: 100%;
        min-height: 400px;
      }
    }

    .pip-header {
      display: flex;
      justify-content: space-between;
      align-items: center;
      margin-bottom: 10px;
    }

    .pip-header h3 {
      font-size: 0.9em;
      font-weight: 700;
      margin: 0;
    }

    .pip-close-btn {
      background: rgba(255, 0, 0, 0.3);
      border: 1px solid rgba(255, 0, 0, 0.5);
      color: white;
      padding: 5px 10px;
      border-radius: 5px;
      cursor: pointer;
      font-size: 0.6em;
    }

    .pip-placeholder {
      flex: 1;
      display: flex;
      flex-direction: column;
      align-items: center;
      justify-content: center;
      text-align: center;
      padding: 20px;
      min-height: 0; /* Allow flex shrinking */
    }

    .pip-placeholder-icon {
      font-size: 2.5em;
      margin-bottom: 10px;
      opacity: 0.5;
    }

    .pip-placeholder p {
      font-size: 0.65em;
      opacity: 0.7;
      margin: 5px 0;
    }

    .pip-hint {
      font-size: 1em !important;
      opacity: 0.5 !important;
    }

    .pip-active {
      flex: 1;
      display: flex;
      flex-direction: column;
      min-height: 0; /* Allow flex shrinking */
      overflow: hidden;
    }

    .pip-info {
      margin-bottom: 15px;
      font-size: 1.4em;
      font-weight: 600;
    }

    .pip-window-zone {
      flex: 1;
      background: rgba(0, 0, 0, 0.7);
      border-radius: 15px;
      border: 2px dashed rgba(255, 255, 255, 0.2);
      display: flex;
      flex-direction: column;
      align-items: center;
      justify-content: center;
      min-height: 0; /* Allow flex shrinking */
      position: relative;
      margin-bottom: 20px;
      overflow: hidden;
    }

    /* Dedicated viewport box that maintains chosen aspect ratio */
    .pip-viewport {
      width: 100%;
      max-width: 100%;
      height: 100%;
      max-height: 100%;
      background: rgba(0, 0, 0, 0.5);
      border: 1px solid rgba(255, 255, 255, 0.2);
      border-radius: 10px;
      position: relative;
    }

    .pip-viewport iframe {
      position: absolute;
      top: 0;
      left: 0;
      width: 100%;
      height: 100%;
      border: 0;
      border-radius: 10px;
      background: #000;
      display: block; /* Show iframe when embedded */
    }
    
    .pip-viewport iframe.hidden {
      display: none; /* Hide when no content */
    }

    .pip-zone-hint {
      color: rgba(255, 255, 255, 0.4);
      font-size: 1.1em;
      text-align: center;
      margin-bottom: 15px;
    }

    .pip-expand-btn {
      background: linear-gradient(135deg, #1e88e5, #1565c0);
      border: none;
      color: white;
      padding: 15px 30px;
      border-radius: 12px;
      font-size: 1.2em;
      cursor: pointer;
      transition: all 0.3s ease;
    }

    .pip-expand-btn:hover {
      transform: scale(1.05);
      box-shadow: 0 4px 15px rgba(30, 136, 229, 0.5);
    }

    .pip-controls {
      display: flex;
      gap: 15px;
      justify-content: center;
    }

    .pip-btn {
      background: rgba(255, 255, 255, 0.1);
      border: 1px solid rgba(255, 255, 255, 0.3);
      color: white;
      padding: 12px 25px;
      border-radius: 10px;
      font-size: 1.1em;
      cursor: pointer;
      transition: all 0.3s ease;
    }

    .pip-btn:hover {
      background: rgba(255, 255, 255, 0.2);
      transform: translateY(-2px);
    }

    .pip-btn-secondary {
      background: rgba(255, 255, 255, 0.05);
    }

    /* ========== SYSTEM CONTROLS MODAL ========== */
    .system-modal {
      display: none;
      position: fixed;
      top: 0;
      left: 0;
      width: 100%;
      height: 100%;
      background: rgba(0, 0, 0, 0.9);
      z-index: 1000;
      padding: 40px;
      overflow-y: auto;
    }

    .system-modal.active {
      display: flex;
      align-items: center;
      justify-content: center;
    }

    .system-modal-content {
      background: rgba(10, 25, 41, 0.95);
      border-radius: 20px;
      padding: 40px;
      max-width: 800px;
      width: 100%;
      border: 1px solid rgba(255, 255, 255, 0.2);
    }

    .system-modal-header {
      display: flex;
      justify-content: space-between;
      align-items: center;
      margin-bottom: 30px;
    }

    .system-modal-header h2 {
      font-size: 2.2em;
      margin: 0;
    }

    .system-modal-close {
      background: rgba(255, 0, 0, 0.3);
      border: 1px solid rgba(255, 0, 0, 0.5);
      color: white;
      padding: 12px 24px;
      border-radius: 10px;
      cursor: pointer;
      font-size: 1.3em;
    }

    .system-controls-grid {
      display: grid;
      grid-template-columns: 1fr;
      gap: 25px;
    }

    .system-control-group {
      background: rgba(255, 255, 255, 0.05);
      padding: 20px;
      border-radius: 15px;
      border: 1px solid rgba(255, 255, 255, 0.1);
    }

    .system-control-group h3 {
      font-size: 1.5em;
      margin-bottom: 15px;
      opacity: 0.9;
    }

    .section-title {
      font-size: 1.8em;
      font-weight: 700;
      text-align: left;
      opacity: 0.95;
      margin-bottom: 15px;
      text-shadow: 3px 3px 6px rgba(0, 0, 0, 0.9);
    }

    .button-grid {
      display: grid;
      grid-template-columns: repeat(3, 1fr); /* 3 columns for better screen usage */
      gap: 20px;
    }

    /* 4K: Keep 3 columns, larger gaps */
    @media (min-width: 3840px) {
      .button-grid {
        grid-template-columns: repeat(3, 1fr);
        gap: 40px;
      }
    }

    /* 8K: Keep 3 columns, larger gaps */
    @media (min-width: 7680px) {
      .button-grid {
        grid-template-columns: repeat(3, 1fr);
        gap: 80px;
      }
    }

    .dashboard-button {
      background: rgba(0, 0, 0, 0.7);
      border: 3px solid rgba(255, 255, 255, 0.3);
      border-radius: 15px;
      padding: 20px 15px 20px 15px;
      font-size: 1.3em;
      color: #fff;
      cursor: pointer;
      transition: all 0.3s ease;
      display: flex;
      flex-direction: column;
      align-items: center;
      justify-content: space-between; /* Push label to bottom */
      gap: 8px;
      font-family: 'Roboto', sans-serif;
      position: relative;
      overflow: hidden;
      min-height: 200px;
    }

    /* 4K: Much larger buttons */
    @media (min-width: 3840px) {
      .dashboard-button {
        padding: 70px 40px;
        font-size: 1.6em;
        min-height: 320px;
        border-width: 6px;
      }
    }

    /* 8K: Extra large buttons */
    @media (min-width: 7680px) {
      .dashboard-button {
        padding: 140px 80px;
        font-size: 2em;
        min-height: 640px;
        border-width: 12px;
      }
    }

    .dashboard-button:hover {
      background: rgba(0, 0, 0, 0.85);
      transform: translateY(-3px);
      box-shadow: 0 10px 25px rgba(0, 0, 0, 0.5);
      border-color: rgba(255, 255, 255, 0.5);
    }

    .dashboard-button:active {
      transform: translateY(-1px);
    }

    /* ========== TV REMOTE CONTROL FOCUS STATES ========== */
    .dashboard-button:focus {
      outline: 6px solid #ffd700;
      outline-offset: 8px;
      background: rgba(255, 255, 255, 0.35);
      transform: scale(1.08);
      z-index: 10;
      box-shadow: 0 0 0 4px rgba(255, 215, 0, 0.3),
                  0 0 30px rgba(255, 215, 0, 0.6);
    }

    /* Pulsing animation for focused element */
    @keyframes focusPulse {
      0%, 100% { box-shadow: 0 0 0 4px rgba(255, 215, 0, 0.3), 0 0 30px rgba(255, 215, 0, 0.6); }
      50% { box-shadow: 0 0 0 8px rgba(255, 215, 0, 0.5), 0 0 50px rgba(255, 215, 0, 0.8); }
    }

    .dashboard-button:focus {
      animation: focusPulse 2s ease-in-out infinite;
    }

    .dashboard-button.clicked {
      border-color: #ffd700;
      box-shadow: 0 0 20px rgba(255, 215, 0, 0.6), 0 0 40px rgba(255, 215, 0, 0.4);
      animation: pulseGold 2s ease-in-out;
    }

    @keyframes pulseGold {
      0%, 100% {
        box-shadow: 0 0 20px rgba(255, 215, 0, 0.6), 0 0 40px rgba(255, 215, 0, 0.4);
      }
      50% {
        box-shadow: 0 0 30px rgba(255, 215, 0, 0.8), 0 0 60px rgba(255, 215, 0, 0.6);
      }
    }

    .button-icon {
      font-size: 4em;
      flex: 1;
      display: flex;
      align-items: center;
      justify-content: center;
    }

    .service-logo {
      width: 100%;
      height: 100%;
      max-width: 140px;
      max-height: 140px;
      object-fit: contain;
      margin-bottom: 0;
      flex: 1;
      /* Sharp rendering on high DPI displays */
      image-rendering: -webkit-optimize-contrast;
      image-rendering: crisp-edges;
    }

    /* 4K: Larger logos */
    @media (min-width: 3840px) {
      .service-logo {
        max-width: 280px;
        max-height: 280px;
      }
    }

    /* 8K: Extra large logos */
    @media (min-width: 7680px) {
      .service-logo {
        max-width: 560px;
        max-height: 560px;
      }
    }

    .button-label {
      font-size: 1.1em;
      font-weight: 700;
      text-shadow: 3px 3px 6px rgba(0, 0, 0, 0.9);
      margin-top: auto; /* Push to bottom */
      width: 100%;
      text-align: center;
    }

    .controls-row {
      display: grid;
      grid-template-columns: 1fr 1fr;
      gap: 20px;
    }

    .volume-lighting-section, .system-section {
      background: rgba(0, 0, 0, 0.5);
      border-radius: 15px;
      padding: 20px;
      border: 1px solid rgba(255, 255, 255, 0.1);
    }

    .collapsible-header {
      cursor: pointer;
      display: flex;
      justify-content: space-between;
      align-items: center;
      user-select: none;
    }

    .collapse-icon {
      font-size: 1.2em;
      transition: transform 0.3s ease;
    }

    .collapse-icon.expanded {
      transform: rotate(180deg);
    }

    .collapsible-content {
      max-height: 0;
      overflow: hidden;
      transition: max-height 0.3s ease;
    }

    .collapsible-content.expanded {
      max-height: 500px;
    }

    .mode-controls {
      display: flex;
      flex-direction: column;
      gap: 12px;
      margin-bottom: 15px;
    }

    .mode-controls .mode-toggle {
      display: flex;
      justify-content: space-between;
      align-items: center;
      padding: 10px 15px;
      background: rgba(255, 255, 255, 0.05);
      border-radius: 8px;
      border: 1px solid rgba(255, 255, 255, 0.1);
      cursor: pointer;
      transition: all 0.3s ease;
    }

    .mode-controls .mode-toggle:hover {
      background: rgba(255, 255, 255, 0.1);
    }

    .mode-controls .mode-toggle span {
      font-size: 0.9em;
      font-weight: 500;
    }

    .audio-section {
      display: flex;
      flex-direction: column;
      gap: 15px;
      margin-top: 15px;
    }

    .audio-output-selector {
      display: flex;
      flex-wrap: wrap;
      gap: 10px;
      justify-content: center;
    }

    .audio-btn {
      background: rgba(100, 100, 255, 0.2);
      border: 1px solid rgba(100, 100, 255, 0.4);
      border-radius: 10px;
      padding: 12px 20px;
      color: #fff;
      cursor: pointer;
      transition: all 0.3s ease;
      font-family: 'Roboto', sans-serif;
      font-size: 0.95em;
    }

    .audio-btn:hover {
      background: rgba(100, 100, 255, 0.4);
      transform: scale(1.05);
    }

    .audio-btn.active {
      background: rgba(100, 255, 100, 0.3);
      border-color: rgba(100, 255, 100, 0.6);
    }

    .volume-control {
      display: flex;
      align-items: center;
      gap: 12px;
      justify-content: center;
    }

    .volume-btn {
      width: 40px;
      height: 40px;
      border-radius: 50%;
      background: rgba(100, 100, 255, 0.3);
      border: 2px solid rgba(100, 100, 255, 0.6);
      color: #fff;
      font-size: 1.2em;
      font-weight: bold;
      cursor: pointer;
      transition: all 0.3s ease;
      display: flex;
      align-items: center;
      justify-content: center;
    }

    .volume-btn:hover {
      background: rgba(100, 100, 255, 0.5);
      transform: scale(1.1);
    }

    .volume-btn:active {
      transform: scale(0.95);
    }

    .volume-icon {
      font-size: 1.2em;
    }

    .volume-slider {
      flex: 1;
      max-width: 300px;
      height: 12px;
      border-radius: 8px;
      background: rgba(255, 255, 255, 0.2);
      outline: none;
      -webkit-appearance: none;
      appearance: none;
      cursor: pointer;
    }

    .volume-slider::-webkit-slider-thumb {
      -webkit-appearance: none;
      appearance: none;
      width: 28px;
      height: 28px;
      border-radius: 50%;
      background: linear-gradient(135deg, #4facfe 0%, #00f2fe 100%);
      cursor: pointer;
      box-shadow: 0 4px 8px rgba(79, 172, 254, 0.3);
      border: 2px solid #fff;
    }

    .volume-slider::-moz-range-thumb {
      width: 28px;
      height: 28px;
      border-radius: 50%;
      background: linear-gradient(135deg, #4facfe 0%, #00f2fe 100%);
      cursor: pointer;
      border: 2px solid #fff;
      box-shadow: 0 4px 8px rgba(79, 172, 254, 0.3);
    }

    .system-controls {
      display: flex;
      flex-direction: column;
      gap: 12px;
      margin-top: 15px;
    }

    .system-btn {
      background: rgba(255, 100, 100, 0.2);
      border: 1px solid rgba(255, 100, 100, 0.4);
      border-radius: 10px;
      padding: 14px 20px;
      color: #fff;
      cursor: pointer;
      transition: all 0.3s ease;
      font-family: 'Roboto', sans-serif;
      font-size: 0.95em;
      width: 100%;
    }

    .system-btn:hover {
      background: rgba(255, 100, 100, 0.4);
      transform: translateX(3px);
    }

    .info-bar {
      margin-top: 25px;
      padding: 20px 25px;
      background: rgba(0, 0, 0, 0.3);
      border-radius: 15px;
      display: grid;
      grid-template-columns: repeat(auto-fit, minmax(200px, 1fr));
      gap: 20px;
      border: 1px solid rgba(255, 255, 255, 0.1);
    }

    .info-item {
      display: flex;
      flex-direction: column;
      align-items: center;
      gap: 8px;
    }

    .info-icon {
      font-size: 2em;
    }

    .info-main {
      font-size: 1.3em;
      font-weight: 500;
    }

    .info-sub {
      font-size: 0.85em;
      opacity: 0.7;
    }

    .lighting-controls {
      display: flex;
      gap: 10px;
      justify-content: center;
      margin-top: 15px;
    }

    .light-btn {
      background: rgba(255, 200, 100, 0.2);
      border: 1px solid rgba(255, 200, 100, 0.4);
      border-radius: 10px;
      padding: 12px 20px;
      color: #fff;
      cursor: pointer;
      transition: all 0.3s ease;
      font-family: 'Roboto', sans-serif;
      font-size: 0.95em;
      display: flex;
      align-items: center;
      gap: 8px;
    }

    .light-btn:hover {
      background: rgba(255, 200, 100, 0.4);
      transform: scale(1.05);
    }

    .light-btn:active {
      transform: scale(0.98);
    }

    .news-ticker {
      margin-top: 25px;
      padding: 15px 25px;
      background: rgba(0, 0, 0, 0.3);
      border-radius: 10px;
      border: 1px solid rgba(255, 255, 255, 0.1);
      overflow: hidden;
      position: relative;
    }

    .news-content {
      display: flex;
      animation: scroll 60s linear infinite;
      white-space: nowrap;
    }

    .news-item {
      margin-right: 100px;
      font-size: 1.2em;
      opacity: 0.9;
      flex-shrink: 0;
      font-weight: 500;
    }

    @keyframes scroll {
      0% {
        transform: translateX(100%);
      }
      100% {
        transform: translateX(-100%);
      }
    }

    .build-info {
      margin-top: 15px;
      padding: 15px 20px;
      background: rgba(0, 0, 0, 0.2);
      border-radius: 10px;
      display: flex;
      justify-content: space-between;
      align-items: center;
      border: 1px solid rgba(255, 255, 255, 0.1);
    }

    .build-number {
      font-size: 1.5em;
      font-weight: 700;
      color: #4facfe;
      text-shadow: 0 0 10px rgba(79, 172, 254, 0.5);
    }

    .build-label {
      font-size: 0.9em;
      opacity: 0.7;
    }

    .help-button {
      position: fixed;
      bottom: 30px;
      right: 30px;
      width: 60px;
      height: 60px;
      background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
      border: none;
      border-radius: 50%;
      color: white;
      font-size: 2em;
      cursor: pointer;
      box-shadow: 0 8px 20px rgba(102, 126, 234, 0.4);
      transition: all 0.3s ease;
      display: flex;
      align-items: center;
      justify-content: center;
      z-index: 1000;
    }

    .help-button:hover {
      transform: scale(1.1);
      box-shadow: 0 12px 30px rgba(102, 126, 234, 0.6);
    }

    .help-modal {
      display: none;
      position: fixed;
      top: 0;
      left: 0;
      width: 100%;
      height: 100%;
      background: rgba(0, 0, 0, 0.8);
      backdrop-filter: blur(10px);
      z-index: 2000;
      overflow-y: auto;
    }

    .help-modal.active {
      display: flex;
      align-items: center;
      justify-content: center;
      animation: fadeIn 0.3s ease;
    }

    @keyframes fadeIn {
      from { opacity: 0; }
      to { opacity: 1; }
    }

    .help-content {
      background: rgba(30, 30, 47, 0.95);
      border: 1px solid rgba(255, 255, 255, 0.2);
      border-radius: 20px;
      padding: 40px;
      max-width: 800px;
      max-height: 90vh;
      overflow-y: auto;
      position: relative;
      animation: slideUp 0.3s ease;
    }

    @keyframes slideUp {
      from {
        transform: translateY(50px);
        opacity: 0;
      }
      to {
        transform: translateY(0);
        opacity: 1;
      }
    }

    .help-close {
      position: absolute;
      top: 20px;
      right: 25px;
      font-size: 2em;
      color: white;
      cursor: pointer;
      background: none;
      border: none;
      opacity: 0.7;
      transition: opacity 0.3s;
    }

    .help-close:hover {
      opacity: 1;
    }

    .help-title {
      font-size: 2.5em;
      margin-bottom: 10px;
      background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
      -webkit-background-clip: text;
      -webkit-text-fill-color: transparent;
      background-clip: text;
    }

    .help-subtitle {
      font-size: 1.2em;
      opacity: 0.7;
      margin-bottom: 30px;
    }

    .feature-section {
      margin-bottom: 30px;
    }

    .feature-section h3 {
      font-size: 1.4em;
      margin-bottom: 15px;
      color: #4facfe;
    }

    .feature-list {
      list-style: none;
      padding: 0;
    }

    .feature-list li {
      padding: 12px 0;
      padding-left: 30px;
      position: relative;
      line-height: 1.6;
    }

    .feature-list li:before {
      content: "✓";
      position: absolute;
      left: 0;
      color: #4facfe;
      font-weight: bold;
      font-size: 1.2em;
    }

    .feature-grid {
      display: grid;
      grid-template-columns: repeat(auto-fit, minmax(200px, 1fr));
      gap: 20px;
      margin-top: 20px;
    }

    .feature-card {
      background: rgba(255, 255, 255, 0.05);
      padding: 20px;
      border-radius: 10px;
      border: 1px solid rgba(255, 255, 255, 0.1);
    }

    .feature-card h4 {
      font-size: 1.1em;
      margin-bottom: 10px;
      color: #4facfe;
    }

    .feature-card p {
      font-size: 0.9em;
      opacity: 0.8;
      line-height: 1.5;
    }

    footer {
      margin-top: 15px;
      font-size: 0.7em;
      opacity: 0.4;
    }

    /* HD Widescreen 16:9 optimization */
    @media (min-width: 1280px) and (min-aspect-ratio: 16/9) {
      .glass-panel {
        padding: 25px 40px;
      }

      h1 {
        font-size: 2em;
      }

      .button-grid {
        grid-template-columns: repeat(3, 1fr); /* Keep 3 columns */
      }

      .controls-row {
        grid-template-columns: 1fr 1fr;
        gap: 20px;
      }
    }

    /* Ultra-wide Cinema 2.35:1 optimization */
    @media (min-width: 2000px) and (min-aspect-ratio: 21/9) {
      body {
        padding: 15px 40px;
      }

      .container {
        max-width: 2560px;
      }

      .glass-panel {
        padding: 20px 50px;
      }

      h1 {
        font-size: 1.8em;
      }

      .header {
        margin-bottom: 20px;
      }
      
      .button-grid {
        grid-template-columns: repeat(3, 1fr); /* Keep 3 columns */
        gap: 12px;
      }

      .dashboard-button {
        padding: 20px 12px;
        font-size: 1em;
      }

      .button-icon {
        font-size: 2em;
      }

      .button-label {
        font-size: 0.8em;
      }

      .controls-row {
        grid-template-columns: 1fr 1fr;
        gap: 15px;
      }

      .section-title {
        font-size: 1em;
        margin-bottom: 8px;
      }

      .volume-lighting-section, .system-section {
        padding: 15px;
      }

      .audio-btn {
        padding: 10px 16px;
        font-size: 0.85em;
      }

      .system-btn {
        padding: 12px 16px;
        font-size: 0.85em;
      }

      footer {
        margin-top: 15px;
        font-size: 0.75em;
      }
    }

    /* Mobile and small screens */
    @media (max-width: 768px) {
      .logo {
        height: 45px;
      }

      h1 {
        font-size: 1.6em;
      }
      
      .header {
        flex-direction: column;
        align-items: stretch;
      }

      .logo-title {
        justify-content: center;
      }

      .status-message {
        min-width: auto;
      }

      .main-content {
        gap: 20px;
      }

      .button-grid {
        grid-template-columns: 1fr; /* Single column on mobile */
        gap: 15px;
      }

      .dashboard-button {
        padding: 20px 12px;
      }

      .controls-row {
        grid-template-columns: 1fr;
        gap: 15px;
      }

      .volume-slider {
        max-width: 200px;
      }
    }
  </style>
</head>
<body>
  <!-- Animated Background Shapes -->
  <div class="shape shape1"></div>
  <div class="shape shape2"></div>
  <div class="shape shape3"></div>

  <!-- Help Button -->
  <button class="help-button" onclick="toggleHelp()" title="Help & Features">
    ❓
  </button>

  <!-- Help Modal -->
  <div class="help-modal" id="helpModal" onclick="closeHelpOnBackground(event)">
    <div class="help-content">
      <button class="help-close" onclick="toggleHelp()">×</button>
      
      <h2 class="help-title">📺 MediaBox AI Features</h2>
      <p class="help-subtitle">Your Complete Home Entertainment Hub</p>

      <div class="feature-section">
        <h3>🎬 Streaming & Services</h3>
        <ul class="feature-list">
          <li><strong>Browser & Container Modes:</strong> Toggle between opening services in your Windows browser or launching in Docker container</li>
          <li><strong>Netflix, Prime Video, Plex:</strong> One-click access to all your favorite streaming platforms</li>
          <li><strong>Plexamp & Spotify:</strong> Music streaming with Plexamp for your library and Spotify Web</li>
          <li><strong>YouTube & Live TV:</strong> Watch videos and live TV channels instantly</li>
          <li><strong>Remote Plex Server:</strong> Connected to netlite.community for your media library</li>
          <li><strong>News:</strong> BBC News with clean, TV-friendly layout</li>
          <li><strong>Telegram:</strong> Web-based Telegram messaging client</li>
          <li><strong>Calendar:</strong> Outlook Bookings calendar for appointments and scheduling</li>
        </ul>
      </div>

      <div class="feature-section">
        <h3>🔊 Audio Control</h3>
        <ul class="feature-list">
          <li><strong>Multiple Outputs:</strong> Switch between HDMI, SPDIF (Optical/Coax), and Analog (3.5mm)</li>
          <li><strong>Volume Control:</strong> Adjust volume with smooth slider interface</li>
          <li><strong>Hot-Swapping:</strong> Change audio outputs on-the-fly without interrupting playback</li>
        </ul>
      </div>

      <div class="feature-section">
        <h3>💡 Smart Home Integration</h3>
        <ul class="feature-list">
          <li><strong>Home Assistant:</strong> Full smart home control at port 8123</li>
          <li><strong>Light Control:</strong> Adjust room lighting brightness with smooth slider interface</li>
          <li><strong>Automation Ready:</strong> IR remote and KDE Connect compatible</li>
        </ul>
      </div>

      <div class="feature-section">
        <h3>📊 Live Information</h3>
        <div class="feature-grid">
          <div class="feature-card">
            <h4>🕐 Real-Time Clock</h4>
            <p>Current time and date updated every second</p>
          </div>
          <div class="feature-card">
            <h4>🌤️ Weather</h4>
            <p>Live temperature and conditions, updates every 10 minutes</p>
          </div>
          <div class="feature-card">
            <h4>🌐 Network Info</h4>
            <p>Public IP address and connection status</p>
          </div>
          <div class="feature-card">
            <h4>💾 System Status</h4>
            <p>Monitor system load and health</p>
          </div>
        </div>
      </div>

      <div class="feature-section">
        <h3>⚙️ System Features</h3>
        <ul class="feature-list">
          <li><strong>Widescreen Optimized:</strong> Adapts to 16:9 HD and 2.35:1 cinema displays</li>
          <li><strong>Flask Auto-Reload:</strong> Code changes apply automatically without Docker restart</li>
          <li><strong>Responsive Design:</strong> Works on desktop, tablet, and mobile</li>
          <li><strong>Version Tracking:</strong> Build numbers track every change</li>
          <li><strong>Docker Powered:</strong> Isolated, reproducible environment</li>
          <li><strong>Network Accessible:</strong> Access from any device on your LAN</li>
        </ul>
      </div>

      <div class="feature-section">
        <h3>🎮 Control Methods</h3>
        <ul class="feature-list">
          <li><strong>Web Interface:</strong> Full control via browser dashboard</li>
          <li><strong>IR Remote:</strong> Traditional remote control support</li>
          <li><strong>KDE Connect:</strong> Control from your phone</li>
          <li><strong>API Access:</strong> RESTful API for custom integrations</li>
        </ul>
      </div>

      <div class="feature-section" style="background: rgba(102, 126, 234, 0.1); padding: 20px; border-radius: 10px;">
        <h3>💡 Quick Tips</h3>
        <ul class="feature-list">
          <li>Use the mode toggle (top-right) to switch between Browser and Container modes</li>
          <li>All links automatically adapt to your network IP address</li>
          <li>Weather and network info update automatically in the background</li>
          <li>Press ESC key to close this help dialog</li>
        </ul>
      </div>
    </div>
  </div>

  <div class="container">
    <div class="glass-panel">
      <!-- Header with Title (left) and Status/Weather/Time (right) -->
      <div class="header">
        <div class="logo-title">
          <a class="app-link" href="https://netlite.network/mediabox" target="_blank" rel="noopener noreferrer">
            <img src="logo.png" alt="MediaBox AI" class="logo" onerror="this.style.display='none'">
            <h1>MediaBox AI</h1>
          </a>
        </div>
        
        <div class="header-right">
          <button class="pip-toggle-btn hidden" id="pipToggleBtn" onclick="togglePiPPanel()" title="Toggle Preview Panel">
            <span id="pipToggleIcon">📺</span>
            <span id="pipToggleText">Preview</span>
          </button>
          <div class="resolution-display" id="resolutionDisplay" title="Current Screen Resolution">
            <span class="resolution-icon">📺</span>
            <span class="resolution-text" id="resolutionText">--</span>
          </div>
          <div class="build-number" id="buildNumber">Build 17</div>
          <div class="status-message" id="statusMessage">Ready</div>
          <div class="header-info-item">
            <div class="header-info-icon" id="headerWeatherIcon">🌤️</div>
            <div>
              <div class="header-info-main" id="headerTemperature">--°</div>
              <div class="header-info-sub" id="headerWeatherDesc">Loading...</div>
            </div>
          </div>
          <div class="header-info-item">
            <div class="header-info-icon">🕐</div>
            <div>
              <div class="header-info-main" id="headerTime">--:--</div>
              <div class="header-info-sub" id="headerDate">Loading...</div>
            </div>
          </div>
        </div>
      </div>

      <!-- Main Content Grid - Split View -->
      <div class="main-content">
        <!-- Left: Services Section -->
        <div class="services-section">
          <div class="section-title">📺 Services</div>
      <div class="button-grid">
              <button class="dashboard-button" onclick="launchService('netflix')" oncontextmenu="event.preventDefault(); showPiPPreview('Netflix', SERVICE_URLS.netflix); return false;" data-service="netflix">
                <img src="https://cdn.worldvectorlogo.com/logos/netflix-3.svg" class="service-logo" alt="Netflix" onerror="this.style.display='none'; this.nextElementSibling.style.display='block';">
                <span class="button-icon" style="display:none;">🎬</span>
          <span class="button-label">Netflix</span>
        </button>
              <button class="dashboard-button" onclick="launchService('amazon')" oncontextmenu="event.preventDefault(); showPiPPreview('Amazon Prime', SERVICE_URLS.amazon); return false;" data-service="amazon">
                <img src="https://cdn.worldvectorlogo.com/logos/amazon-prime-video-1.svg" class="service-logo" alt="Amazon Prime" onerror="this.style.display='none'; this.nextElementSibling.style.display='block';">
                <span class="button-icon" style="display:none;">🎞️</span>
          <span class="button-label">Amazon Prime</span>
        </button>
              <button class="dashboard-button" onclick="launchService('appletv')" oncontextmenu="event.preventDefault(); showPiPPreview('Apple TV+', SERVICE_URLS.appletv); return false;" data-service="appletv">
                <img src="https://cdn.worldvectorlogo.com/logos/apple-tv-plus-1.svg" class="service-logo" alt="Apple TV+" onerror="this.style.display='none'; this.nextElementSibling.style.display='block';">
                <span class="button-icon" style="display:none;">🍎</span>
          <span class="button-label">Apple TV+</span>
        </button>
              <button class="dashboard-button" onclick="launchService('youtube')" oncontextmenu="event.preventDefault(); showPiPPreview('YouTube', SERVICE_URLS.youtube); return false;" data-service="youtube">
                <img src="https://cdn.worldvectorlogo.com/logos/youtube-icon-2.svg" class="service-logo" alt="YouTube" onerror="this.style.display='none'; this.nextElementSibling.style.display='block';">
                <span class="button-icon" style="display:none;">▶️</span>
          <span class="button-label">YouTube</span>
        </button>
              <button class="dashboard-button" onclick="launchService('plex')" oncontextmenu="event.preventDefault(); showPiPPreview('Plex', SERVICE_URLS.plex); return false;" data-service="plex">
                <img src="plex film.jpg" class="service-logo" alt="Plex" onerror="this.style.display='none'; this.nextElementSibling.style.display='block';">
                <span class="button-icon" style="display:none;">📺</span>
          <span class="button-label">Plex</span>
        </button>
              <button class="dashboard-button" onclick="launchService('livetv')" oncontextmenu="event.preventDefault(); showPiPPreview('Live TV', SERVICE_URLS.livetv); return false;" data-service="livetv">
          <img src="tvip.jpg" class="service-logo" alt="Live TV" onerror="this.style.display='none'; this.nextElementSibling.style.display='block';">
          <span class="button-icon" style="display:none;">📡</span>
          <span class="button-label">Live TV</span>
        </button>
              <button class="dashboard-button" onclick="launchService('plexamp')" oncontextmenu="event.preventDefault(); showPiPPreview('Plexamp', SERVICE_URLS.plexamp); return false;" data-service="plexamp">
                <img src="plex music.jpg" class="service-logo" alt="Plexamp" onerror="this.style.display='none'; this.nextElementSibling.style.display='block';">
                <span class="button-icon" style="display:none;">🎵</span>
          <span class="button-label">Plexamp</span>
        </button>
              <button class="dashboard-button" onclick="launchService('spotify')" oncontextmenu="event.preventDefault(); showPiPPreview('Spotify', SERVICE_URLS.spotify); return false;" data-service="spotify">
                <img src="https://open.spotify.com/favicon.ico" class="service-logo" alt="Spotify" onerror="this.style.display='none'; this.nextElementSibling.style.display='block';">
                <span class="button-icon" style="display:none;">🎧</span>
          <span class="button-label">Spotify</span>
        </button>
              <button class="dashboard-button" onclick="launchService('smarthome')" oncontextmenu="event.preventDefault(); showPiPPreview('Smart Home', SERVICE_URLS.smarthome); return false;" data-service="smarthome">
                <img src="https://cdn.worldvectorlogo.com/logos/home-assistant.svg" class="service-logo" alt="Home Assistant" onerror="this.style.display='none'; this.nextElementSibling.style.display='block';">
                <span class="button-icon" style="display:none;">🏠</span>
          <span class="button-label">Smart Home</span>
        </button>
              <button class="dashboard-button" onclick="launchService('news')" oncontextmenu="event.preventDefault(); showPiPPreview('News', SERVICE_URLS.news); return false;" data-service="news">
                <img src="https://cdn.worldvectorlogo.com/logos/bbc-logo.svg" class="service-logo" alt="BBC News" onerror="this.style.display='none'; this.nextElementSibling.style.display='block';">
                <span class="button-icon" style="display:none;">📰</span>
                <span class="button-label">News</span>
              </button>
              <button class="dashboard-button" onclick="launchService('telegram')" data-service="telegram">
                <img src="https://cdn.worldvectorlogo.com/logos/telegram-1.svg" class="service-logo" alt="Telegram" onerror="this.style.display='none'; this.nextElementSibling.style.display='block';">
                <span class="button-icon" style="display:none;">💬</span>
                <span class="button-label">Telegram</span>
              </button>
              <button class="dashboard-button" onclick="launchService('calendar')" data-service="calendar">
                <img src="https://cdn.worldvectorlogo.com/logos/microsoft-outlook-2019.svg" class="service-logo" alt="Calendar" onerror="this.style.display='none'; this.nextElementSibling.style.display='block';">
                <span class="button-icon" style="display:none;">📅</span>
                <span class="button-label">Calendar</span>
        </button>
              <button class="dashboard-button" onclick="openSystemControls()" data-service="system">
                <span class="button-icon">⚙️</span>
                <span class="button-label">System</span>
              </button>
      </div>
          </div>


        <!-- Right: PiP Preview Area -->
        <div class="pip-preview-section">
          <div class="pip-header">
            <h3 id="pipTitle">Preview</h3>
            <button class="pip-close-btn" onclick="closePiP()" style="display: none;" id="pipCloseBtn">✕</button>
          </div>
          
          <div class="pip-placeholder" id="pipPlaceholder">
            <div class="pip-placeholder-icon">📺</div>
            <p>Select a service to preview</p>
            <p class="pip-hint">Service will open in a positioned window</p>
          </div>
          
          <div class="pip-active" id="pipActive" style="display: none;">
            <div class="pip-info">
              <span id="pipServiceName">Netflix</span>
            </div>
            
            <!-- PiP Window Zone - positioned window appears here -->
            <div class="pip-window-zone" id="pipZone">
              <p class="pip-zone-hint">Service window will appear here</p>
            <div class="pip-viewport" id="pipViewport"></div>
              <button class="pip-expand-btn" id="pipExpandBtn" onclick="expandPiP()" style="display: none;">
                ↗ Expand to Full Screen
              </button>
            </div>
            
            <div class="pip-controls">
              <button class="pip-btn" onclick="expandPiP()">↗ Full Screen</button>
              <button class="pip-btn pip-btn-secondary" onclick="repositionPiP()">↻ Reposition</button>
            </div>
          </div>
        </div>
      </div>

      <!-- Info Bar and News Ticker removed for cleaner layout -->
    </div>
  </div>

  <!-- System Controls Modal -->
  <div class="system-modal" id="systemModal">
    <div class="system-modal-content">
      <div class="system-modal-header">
        <h2>⚙️ System Controls</h2>
        <button class="system-modal-close" onclick="closeSystemControls()">✕</button>
      </div>
      
      <div class="system-controls-grid">
            <!-- Volume Control -->
        <div class="system-control-group">
          <h3>🔊 Volume Control</h3>
          <div class="volume-control">
            <button class="volume-btn" onclick="adjustVolume(-5)">-</button>
            <span class="volume-icon">🔈</span>
            <input type="range" class="volume-slider" id="volumeSliderModal" min="0" max="100" value="50" oninput="setVolume(this.value)">
            <span class="volume-icon">🔊</span>
            <button class="volume-btn" onclick="adjustVolume(5)">+</button>
            <span id="volumeValueModal">50%</span>
          </div>
        </div>
            
        <!-- Lighting Control -->
        <div class="system-control-group">
          <h3>💡 Room Lighting</h3>
              <div class="volume-control">
                <button class="volume-btn" onclick="adjustLightBrightness(-10)">-</button>
                <span class="volume-icon">🔅</span>
            <input type="range" class="volume-slider" id="lightSliderModal" min="0" max="100" value="50" oninput="setLightBrightness(this.value)">
                <span class="volume-icon">🔆</span>
                <button class="volume-btn" onclick="adjustLightBrightness(10)">+</button>
            <span id="lightValueModal">50%</span>
            </div>
      </div>

        <!-- Audio Output -->
        <div class="system-control-group">
          <h3>🔊 Audio Output</h3>
          <div class="audio-output-selector" id="audioOutputsModal">
            <button class="audio-btn" onclick="switchAudio('hdmi')">HDMI</button>
            <button class="audio-btn" onclick="switchAudio('spdif')">SPDIF</button>
            <button class="audio-btn" onclick="switchAudio('analog')">Analog</button>
            </div>
        </div>
        
        <!-- Launch Mode -->
        <div class="system-control-group">
          <h3>🖥️ Launch Mode</h3>
              <div class="mode-controls">
                <div class="mode-toggle" onclick="toggleLaunchMode()">
                  <span id="modeLabel">🖥️ Container Mode</span>
                  <div class="toggle-switch" id="modeSwitch">
                    <div class="toggle-slider"></div>
                  </div>
                </div>
                <div class="mode-toggle" onclick="toggleHassAutoLogin()">
                  <span id="hassAutoLoginLabel">🔐 HA Manual Login</span>
                  <div class="toggle-switch" id="hassAutoLoginSwitch">
                    <div class="toggle-slider"></div>
                  </div>
                </div>
              </div>
              </div>
              
              <!-- System Actions -->
        <div class="system-control-group">
          <h3>⚙️ System Actions</h3>
      <div class="system-controls">
        <button class="system-btn" onclick="refreshAudioDevices()">🔄 Refresh Audio</button>
        <button class="system-btn" onclick="systemAction('shutdown')">🔌 Shutdown</button>
        <button class="system-btn" onclick="systemAction('restart')">🔃 Restart</button>
              </div>
        </div>
      </div>
    </div>
  </div>

  <script>
    const API_BASE = '/api';  // Use relative path since Flask serves both
    let currentVolume = 50;
    let currentLightLevel = 50;
    
    // Detect if running in Electron or Browser
    const isElectron = typeof window !== 'undefined' && window.electronAPI !== undefined;
    const isBrowser = !isElectron;
    
    let browserMode = isBrowser; // false = Electron Mode, true = Browser Mode
    let hassAutoLogin = false; // false = Manual Login, true = Auto-Login
    let pipWindow = null; // Electron: native window via IPC; Browser: popup handle
    let currentPiPService = null;
    let lastClickedService = null;
    let lastClickTime = 0;
    let hassCredentials = { username: '', password: '' };
    let pipAspectMode = 'auto'; // 'auto' | '16x9' | '2351'
    let pipPanelVisible = true; // PIP panel visibility state
    
    // Log environment on load
    console.log('Environment:', isElectron ? 'Electron' : 'Browser');
    console.log('Mode:', browserMode ? 'Browser Mode' : 'Electron Mode');
    
    // Auto-detect and configure PIP panel based on environment
    function configurePiPPanel() {
      const pipToggleBtn = document.getElementById('pipToggleBtn');
      const pipPreviewSection = document.querySelector('.pip-preview-section');
      
      if (isElectron) {
        // Electron mode - show toggle button and PIP panel
        if (pipToggleBtn) pipToggleBtn.classList.remove('hidden');
        if (pipPreviewSection) pipPreviewSection.classList.remove('browser-mode');
        console.log('PIP Panel: Enabled (Electron mode)');
      } else {
        // Browser mode - hide toggle button and PIP panel
        if (pipToggleBtn) pipToggleBtn.classList.add('hidden');
        if (pipPreviewSection) pipPreviewSection.classList.add('browser-mode');
        console.log('PIP Panel: Disabled (Browser mode - PIP not supported)');
      }
    }
    
    // Toggle PIP panel visibility
    function togglePiPPanel() {
      pipPanelVisible = !pipPanelVisible;
      const pipPreviewSection = document.querySelector('.pip-preview-section');
      const pipToggleBtn = document.getElementById('pipToggleBtn');
      const pipToggleIcon = document.getElementById('pipToggleIcon');
      const pipToggleText = document.getElementById('pipToggleText');
      
      if (pipPanelVisible) {
        // Show panel
        if (pipPreviewSection) pipPreviewSection.classList.remove('browser-mode');
        if (pipToggleBtn) pipToggleBtn.classList.add('active');
        if (pipToggleIcon) pipToggleIcon.textContent = '📺';
        if (pipToggleText) pipToggleText.textContent = 'Preview ON';
        showStatus('Preview panel enabled', 'success');
        console.log('PIP Panel: Shown');
      } else {
        // Hide panel
        if (pipPreviewSection) pipPreviewSection.classList.add('browser-mode');
        if (pipToggleBtn) pipToggleBtn.classList.remove('active');
        if (pipToggleIcon) pipToggleIcon.textContent = '📺';
        if (pipToggleText) pipToggleText.textContent = 'Preview OFF';
        showStatus('Preview panel disabled', 'info');
        console.log('PIP Panel: Hidden');
        
        // Close any active PIP if panel is hidden
        if (currentPiPService) {
          closePiP();
        }
      }
    }

    // Service URL mappings
    // Using window.location.hostname for smarthome so it works from any device on the network
    const SERVICE_URLS = {
      netflix: 'https://www.netflix.com',
      plex: 'http://netlite.community:32400/web/index.html',
      plexamp: 'https://plexamp.com/web?server=netlite.community:32400',  // Plexamp web interface with server
      amazon: 'https://www.primevideo.com/collection/IncludedwithPrime',
      appletv: 'https://tv.apple.com/',
      youtube: 'https://www.youtube.com',
      spotify: 'https://open.spotify.com',
      smarthome: 'http://' + window.location.hostname + ':8123',
      livetv: 'http://' + window.location.hostname + ':8080/iptv',
      news: 'https://www.bbc.com/news',  // BBC News - clean, TV-friendly layout
      telegram: 'https://web.telegram.org',
      calendar: 'https://outlook.office.com/bookings/calendar'  // Outlook Bookings Calendar
    };

    // Fetch Home Assistant credentials
    async function fetchHassCredentials() {
      try {
        const response = await fetch(`${API_BASE}/hass-config`);
        const data = await response.json();
        if (data.success) {
          hassCredentials.username = data.username;
          hassCredentials.password = data.password;
        }
      } catch (err) {
        console.error('Failed to fetch HA credentials:', err);
      }
    }

    // Toggle Home Assistant Auto-Login
    function toggleHassAutoLogin() {
      hassAutoLogin = !hassAutoLogin;
      const hassSwitch = document.getElementById('hassAutoLoginSwitch');
      const hassLabel = document.getElementById('hassAutoLoginLabel');
      
      if (hassAutoLogin) {
        hassSwitch.classList.add('active');
        hassLabel.textContent = '🔓 HA Auto-Login';
        showStatus('Home Assistant Auto-Login enabled', 'success');
      } else {
        hassSwitch.classList.remove('active');
        hassLabel.textContent = '🔐 HA Manual Login';
        showStatus('Home Assistant Auto-Login disabled', 'success');
      }
      
      // Save preference to localStorage
      localStorage.setItem('hassAutoLogin', hassAutoLogin ? 'enabled' : 'disabled');
    }

    // Open Home Assistant with auto-login
    function openHomeAssistantWithLogin() {
      const hassUrl = 'http://' + window.location.hostname + ':8123';
      
      // For now, just open Home Assistant normally
      // Note: Auto-login requires Home Assistant long-lived access token
      // which should be configured in the Home Assistant UI and stored as a cookie
      showStatus('Tip: Use Home Assistant "Remember me" checkbox for auto-login', 'info');
      window.open(hassUrl, '_blank');
    }

    // Toggle between Electron Mode and Browser Mode
    function toggleLaunchMode() {
      browserMode = !browserMode;
      const modeSwitch = document.getElementById('modeSwitch');
      const modeLabel = document.getElementById('modeLabel');
      
      if (browserMode) {
        modeSwitch.classList.add('active');
        modeLabel.textContent = '🌐 Browser Mode';
        showStatus('Browser Mode - Services open in new tabs', 'success');
      } else {
        modeSwitch.classList.remove('active');
        modeLabel.textContent = '🖥️ Electron Mode';
        showStatus('Electron Mode - Services open in PIP windows', 'success');
      }
      
      // Save preference to localStorage
      localStorage.setItem('launchMode', browserMode ? 'browser' : 'electron');
    }

    // Launch streaming service
    function launchService(service) {
      // If it's the system button, open system controls
      if (service === 'system') {
        openSystemControls();
        return;
      }
      
      // Highlight the clicked button with yellow border animation
      document.querySelectorAll('.dashboard-button').forEach(btn => {
        btn.classList.remove('clicked');
      });
      const clickedButton = document.querySelector('[data-service="' + service + '"]');
      if (clickedButton) {
        clickedButton.classList.add('clicked');
        // Remove the class after animation completes
        setTimeout(() => {
          clickedButton.classList.remove('clicked');
        }, 2000);
      }
      
      // Check if this is a second press on the same service (within 5 seconds)
      const currentTime = Date.now();
      const isSecondPress = (lastClickedService === service && (currentTime - lastClickTime) < 5000 && currentPiPService === service);
      
      // Update tracking
      lastClickedService = service;
      lastClickTime = currentTime;
      
      // If second press on same service that's in preview, expand to full screen
      if (isSecondPress) {
        showStatus(`Expanding ${service} to full screen...`, 'info');
        expandPiP();
          return;
        }
        
      // First press or different service: Show in preview
        const url = SERVICE_URLS[service];
        if (url) {
        showStatus(`Loading ${service} in preview...`, 'info');
        showPiPPreview(service, url);
      }
    }

    // Old browser/container mode code removed - now all services use preview-first approach

    // Switch audio output
    function switchAudio(output) {
      showStatus(`Switching to ${output}...`, 'info');
      fetch(`${API_BASE}/switch-audio`, {
        method: 'POST',
        headers: {
          'Content-Type': 'application/json'
        },
        body: JSON.stringify({ output: output })
      })
      .then(response => response.json())
      .then(data => {
        showStatus(data.message || `Switched to ${output}`, 'success');
        highlightActiveAudio(output);
      })
      .catch(err => {
        showStatus(`Failed to switch audio: ${err.message}`, 'error');
        console.error(err);
      });
    }

    // Set volume
    function setVolume(value) {
      currentVolume = value;
      document.getElementById('volumeValue').textContent = value + '%';
      
      // Also update modal slider if it exists
      const modalSlider = document.getElementById('volumeSliderModal');
      const modalValue = document.getElementById('volumeValueModal');
      if (modalSlider) modalSlider.value = value;
      if (modalValue) modalValue.textContent = value + '%';
      
      // Debounce the API call
      clearTimeout(window.volumeTimeout);
      window.volumeTimeout = setTimeout(() => {
        fetch(`${API_BASE}/volume`, {
          method: 'POST',
          headers: {
            'Content-Type': 'application/json'
          },
          body: JSON.stringify({ volume: parseInt(value) })
        })
        .then(response => response.json())
        .then(data => {
          showStatus(data.message || `Volume set to ${value}%`, 'success');
        })
        .catch(err => {
          showStatus(`Failed to set volume: ${err.message}`, 'error');
          console.error(err);
        });
      }, 300);
    }

    // Adjust volume by increment/decrement
    function adjustVolume(change) {
      const newVolume = Math.max(0, Math.min(100, currentVolume + change));
      document.getElementById('volumeSlider').value = newVolume;
      setVolume(newVolume);
    }

    // Set light brightness
    function setLightBrightness(value) {
      currentLightLevel = value;
      document.getElementById('lightValue').textContent = value + '%';
      
      // Also update modal slider if it exists
      const modalSlider = document.getElementById('lightSliderModal');
      const modalValue = document.getElementById('lightValueModal');
      if (modalSlider) modalSlider.value = value;
      if (modalValue) modalValue.textContent = value + '%';
      
      // Debounce the API call
      clearTimeout(window.lightTimeout);
      window.lightTimeout = setTimeout(() => {
        fetch(`${API_BASE}/lighting/brightness`, {
          method: 'POST',
          headers: {
            'Content-Type': 'application/json'
          },
          body: JSON.stringify({ brightness: parseInt(value) })
        })
        .then(response => response.json())
        .then(data => {
          showStatus(data.message || `Brightness set to ${value}%`, 'success');
        })
        .catch(err => {
          showStatus(`Failed to set brightness: ${err.message}`, 'error');
          console.error(err);
        });
      }, 300);
    }

    // Adjust light brightness by increment/decrement
    function adjustLightBrightness(change) {
      const newBrightness = Math.max(0, Math.min(100, currentLightLevel + change));
      document.getElementById('lightSlider').value = newBrightness;
      setLightBrightness(newBrightness);
    }

    // System actions
    function systemAction(action) {
      if (action === 'shutdown' || action === 'restart') {
        if (!confirm(`Are you sure you want to ${action} the system?`)) {
          return;
        }
      }
      
      showStatus(`Executing ${action}...`, 'info');
      fetch(`${API_BASE}/${action}`, {
        method: 'POST'
      })
      .then(response => response.json())
      .then(data => {
        showStatus(data.message || `${action} executed`, 'success');
      })
      .catch(err => {
        showStatus(`Failed to ${action}: ${err.message}`, 'error');
        console.error(err);
      });
    }

    // Refresh audio devices
    function refreshAudioDevices() {
      showStatus('Refreshing audio devices...', 'info');
      fetch(`${API_BASE}/audio-devices`)
      .then(response => response.json())
      .then(data => {
        showStatus(`Found ${data.devices?.length || 0} audio devices`, 'success');
        updateAudioDevices(data.devices);
      })
      .catch(err => {
        showStatus(`Failed to refresh audio devices: ${err.message}`, 'error');
        console.error(err);
      });
    }

    // Update audio device buttons
    function updateAudioDevices(devices) {
      if (!devices || devices.length === 0) return;
      
      const container = document.getElementById('audioOutputs');
      container.innerHTML = '';
      
      devices.forEach(device => {
        const btn = document.createElement('button');
        btn.className = 'audio-btn';
        if (device.active) {
          btn.classList.add('active');
        }
        btn.textContent = device.name;
        btn.onclick = () => switchAudio(device.id);
        container.appendChild(btn);
      });
    }

    // Highlight active audio output
    function highlightActiveAudio(output) {
      document.querySelectorAll('.audio-btn').forEach(btn => {
        btn.classList.remove('active');
        if (btn.textContent.toLowerCase().includes(output.toLowerCase())) {
          btn.classList.add('active');
        }
      });
    }

    // Show status message
    function showStatus(message, type = 'info') {
      const statusEl = document.getElementById('statusMessage');
      statusEl.textContent = message;
      
      // Clear previous color classes
      statusEl.style.background = type === 'error' 
        ? 'rgba(255, 100, 100, 0.3)' 
        : type === 'success'
        ? 'rgba(100, 255, 100, 0.3)'
        : 'rgba(0, 0, 0, 0.2)';
      
      // Auto-clear after 5 seconds
      setTimeout(() => {
        if (statusEl.textContent === message) {
          statusEl.textContent = 'Ready';
          statusEl.style.background = 'rgba(0, 0, 0, 0.2)';
        }
      }, 5000);
    }

    // Lighting control
    function adjustLighting(action) {
      showStatus(`${action === 'dim' ? 'Dimming' : 'Brightening'} lights...`, 'info');
      fetch(`${API_BASE}/lighting/${action}`, {
        method: 'POST'
      })
      .then(response => response.json())
      .then(data => {
        showStatus(data.message || `Lights ${action === 'dim' ? 'dimmed' : 'brightened'}`, 'success');
      })
      .catch(err => {
        showStatus(`Failed to adjust lighting: ${err.message}`, 'error');
        console.error(err);
      });
    }

    // Update clock
    function updateClock() {
      const now = new Date();
      const timeStr = now.toLocaleTimeString('en-US', { 
        hour: '2-digit', 
        minute: '2-digit',
        hour12: true 
      });
      const dateStr = now.toLocaleDateString('en-US', { 
        weekday: 'long', 
        month: 'short', 
        day: 'numeric' 
      });
      
      // Update header time (new location)
      document.getElementById('headerTime').textContent = timeStr;
      document.getElementById('headerDate').textContent = dateStr;
    }

    // Fetch weather data
    async function fetchWeather() {
      try {
        // Using wttr.in for simple weather API (no key needed)
        const response = await fetch('https://wttr.in/?format=j1');
        const data = await response.json();
        
        const temp = Math.round((parseInt(data.current_condition[0].temp_F)));
        const desc = data.current_condition[0].weatherDesc[0].value;
        const weatherCode = data.current_condition[0].weatherCode;
        
        // Weather icons based on code
        const weatherIcons = {
          113: '☀️',  // Sunny
          116: '⛅',  // Partly cloudy
          119: '☁️',  // Cloudy
          122: '☁️',  // Overcast
          143: '🌫️',  // Mist
          176: '🌦️',  // Patchy rain possible
          179: '🌨️',  // Patchy snow possible
          200: '⛈️',  // Thundery outbreaks possible
          263: '🌧️',  // Patchy light drizzle
          266: '🌧️',  // Light drizzle
          281: '🌧️',  // Freezing drizzle
          284: '🌧️',  // Heavy freezing drizzle
          293: '🌧️',  // Patchy light rain
          296: '🌧️',  // Light rain
          299: '🌧️',  // Moderate rain
          302: '🌧️',  // Moderate rain
          305: '🌧️',  // Heavy rain
          308: '🌧️',  // Heavy rain
          311: '🌧️',  // Light freezing rain
          314: '🌧️',  // Moderate or heavy freezing rain
          317: '🌨️',  // Light sleet
          320: '🌨️',  // Moderate or heavy sleet
          323: '🌨️',  // Patchy light snow
          326: '❄️',  // Light snow
          329: '❄️',  // Patchy moderate snow
          332: '❄️',  // Moderate snow
          335: '❄️',  // Patchy heavy snow
          338: '❄️',  // Heavy snow
          350: '🌨️',  // Ice pellets
          353: '🌧️',  // Light rain shower
          356: '🌧️',  // Moderate or heavy rain shower
          359: '🌧️',  // Torrential rain shower
          362: '🌨️',  // Light sleet showers
          365: '🌨️',  // Moderate or heavy sleet showers
          368: '🌨️',  // Light snow showers
          371: '❄️',  // Moderate or heavy snow showers
          374: '🌨️',  // Light showers of ice pellets
          377: '🌨️',  // Moderate or heavy showers of ice pellets
          386: '⛈️',  // Patchy light rain with thunder
          389: '⛈️',  // Moderate or heavy rain with thunder
          392: '⛈️',  // Patchy light snow with thunder
          395: '⛈️',  // Moderate or heavy snow with thunder
        };
        
        // Update header weather (new location)
        document.getElementById('headerWeatherIcon').textContent = weatherIcons[weatherCode] || '🌤️';
        document.getElementById('headerTemperature').textContent = `${temp}°F`;
        document.getElementById('headerWeatherDesc').textContent = desc;
      } catch (err) {
        console.error('Weather fetch error:', err);
        document.getElementById('headerWeatherDesc').textContent = 'Weather unavailable';
      }
    }

    // Network, system status, version info, and news ticker removed - elements no longer displayed

    // Fetch and display build number
    async function fetchBuildNumber() {
      try {
        const response = await fetch('build.txt');
        const buildNum = await response.text();
        document.getElementById('buildNumber').textContent = `Build ${buildNum.trim()}`;
      } catch (err) {
        console.error('Failed to fetch build number:', err);
        document.getElementById('buildNumber').textContent = 'Build 17';
      }
    }

    // Update resolution display
    function updateResolutionDisplay() {
      // Get CSS pixels (what the browser reports)
      const cssWidth = window.innerWidth;
      const cssHeight = window.innerHeight;
      
      // Get device pixel ratio (handles display scaling)
      const dpr = window.devicePixelRatio || 1;
      
      // Calculate actual physical resolution
      const physicalWidth = Math.round(cssWidth * dpr);
      const physicalHeight = Math.round(cssHeight * dpr);
      
      const resolutionText = document.getElementById('resolutionText');
      
      // Determine mode based on CSS width (not physical, for layout purposes)
      let mode = '';
      if (cssWidth >= 7680) mode = '8K';
      else if (cssWidth >= 3840) mode = '4K';
      else if (cssWidth >= 1920) mode = 'FHD';
      else if (cssWidth === 1600) mode = 'Proj';  // Projector specific resolution
      else if (cssWidth >= 1280) mode = 'HD';
      else if (cssWidth === 1143) mode = 'TabOne+';  // TabOnePlus specific resolution
      else if (cssWidth >= 768) mode = 'Tab';
      else mode = 'Mob';
      
      // Show both CSS and physical resolution
      const displayText = dpr > 1 
        ? `${physicalWidth}x${physicalHeight} (${mode}) [${cssWidth}x${cssHeight}]`
        : `${cssWidth}x${cssHeight} (${mode})`;
      
      // Update display
      resolutionText.textContent = displayText;
      
      // Log to console for debugging
      console.log(`CSS Resolution: ${cssWidth}x${cssHeight}`);
      console.log(`Physical Resolution: ${physicalWidth}x${physicalHeight}`);
      console.log(`Device Pixel Ratio: ${dpr}`);
      console.log(`Mode: ${mode}`);
    }

    // Initialize and start updates
    function initializeInfoBar() {
      // Update clock immediately and every second
      updateClock();
      setInterval(updateClock, 1000);
      
      // Fetch weather info
      fetchWeather();
      
      // Fetch build number
      fetchBuildNumber();
      
      // Update resolution display
      updateResolutionDisplay();
      
      // Update weather every 10 minutes
      setInterval(fetchWeather, 600000);
      
      // Update build number every 30 seconds (to catch changes)
      setInterval(fetchBuildNumber, 30000);
      
      // Update resolution on window resize
      let resizeTimer;
      window.addEventListener('resize', () => {
        clearTimeout(resizeTimer);
        resizeTimer = setTimeout(updateResolutionDisplay, 250);
      });
    }

    // Restore saved preferences
    function restoreLaunchMode() {
      // Restore launch mode preference (only if not auto-detected)
      const savedMode = localStorage.getItem('launchMode');
      if (savedMode === 'browser') {
        browserMode = true;
        document.getElementById('modeSwitch').classList.add('active');
        document.getElementById('modeLabel').textContent = '🌐 Browser Mode';
      } else if (savedMode === 'electron') {
        browserMode = false;
        document.getElementById('modeSwitch').classList.remove('active');
        document.getElementById('modeLabel').textContent = '🖥️ Electron Mode';
      } else {
        // Auto-detect mode based on environment
        if (isElectron) {
          browserMode = false;
          document.getElementById('modeLabel').textContent = '🖥️ Electron Mode';
        } else {
          browserMode = true;
          document.getElementById('modeSwitch').classList.add('active');
          document.getElementById('modeLabel').textContent = '🌐 Browser Mode';
        }
      }
      
      // Restore Home Assistant auto-login preference
      const savedHassLogin = localStorage.getItem('hassAutoLogin');
      if (savedHassLogin === 'enabled') {
        hassAutoLogin = true;
        document.getElementById('hassAutoLoginSwitch').classList.add('active');
        document.getElementById('hassAutoLoginLabel').textContent = '🔓 HA Auto-Login';
      }
    }

    // Toggle system section collapse
    function toggleSystemCollapse() {
      const content = document.getElementById('systemContent');
      const icon = document.getElementById('systemCollapseIcon');
      
      content.classList.toggle('expanded');
      icon.classList.toggle('expanded');
    }

    // Help modal controls
    function toggleHelp() {
      const modal = document.getElementById('helpModal');
      modal.classList.toggle('active');
      
      // Prevent body scroll when modal is open
      if (modal.classList.contains('active')) {
        document.body.style.overflow = 'hidden';
      } else {
        document.body.style.overflow = 'auto';
      }
    }

    function closeHelpOnBackground(event) {
      if (event.target.id === 'helpModal') {
        toggleHelp();
      }
    }

    // Close help modal with ESC key
    document.addEventListener('keydown', (event) => {
      if (event.key === 'Escape') {
        const modal = document.getElementById('helpModal');
        if (modal.classList.contains('active')) {
          toggleHelp();
        }
      }
    });

    // ========== TV REMOTE CONTROL NAVIGATION ==========
    // Arrow key navigation for TV remotes and keyboards
    document.addEventListener('keydown', (e) => {
      // Don't interfere with ESC key or if help modal is open
      const modal = document.getElementById('helpModal');
      if (modal && modal.classList.contains('active')) return;
      
      const buttons = Array.from(document.querySelectorAll('.dashboard-button'));
      const currentIndex = buttons.findIndex(btn => btn === document.activeElement);
      
      // 3-column grid for TV navigation
      const cols = 3;
      
      let nextIndex = currentIndex;
      
      switch(e.key) {
        case 'ArrowRight':
          // Move right, wrap to next row if at end of row
          if (currentIndex === -1) {
            nextIndex = 0;
          } else {
            const currentRow = Math.floor(currentIndex / cols);
            const currentCol = currentIndex % cols;
            if (currentCol < cols - 1 && currentIndex + 1 < buttons.length) {
              nextIndex = currentIndex + 1;
            } else {
              // Wrap to start of next row
              nextIndex = Math.min((currentRow + 1) * cols, buttons.length - 1);
            }
          }
          break;
        case 'ArrowLeft':
          // Move left, wrap to previous row if at start of row
          if (currentIndex === -1) {
            nextIndex = 0;
          } else {
            const currentRow = Math.floor(currentIndex / cols);
            const currentCol = currentIndex % cols;
            if (currentCol > 0) {
              nextIndex = currentIndex - 1;
            } else {
              // Wrap to end of previous row
              nextIndex = Math.max(currentRow * cols - 1, 0);
            }
          }
          break;
        case 'ArrowDown':
          nextIndex = currentIndex === -1 ? 0 : Math.min(currentIndex + cols, buttons.length - 1);
          break;
        case 'ArrowUp':
          nextIndex = currentIndex === -1 ? 0 : Math.max(currentIndex - cols, 0);
          break;
        case 'Enter':
          if (currentIndex !== -1) {
            buttons[currentIndex]?.click();
          }
          return;
        default:
          return;
      }
      
      e.preventDefault();
      buttons[nextIndex]?.focus();
    });

    // Load initial data on page load
    window.addEventListener('load', () => {
      restoreLaunchMode();
      fetchHassCredentials();
      refreshAudioDevices();
      initializeInfoBar();
      
      // Configure PIP panel based on environment (Electron vs Browser)
      configurePiPPanel();
      
      // Setup PIP window event listeners
      if (window.electronAPI) {
        window.electronAPI.onPiPWindowClosed(() => {
          console.log('PIP window closed');
          // Reset UI if needed
          if (currentPiPService) {
            closePiP();
          }
        });
        
        window.electronAPI.onPiPWindowMoved((event, bounds) => {
          console.log('PIP window moved:', bounds);
        });
        
        window.electronAPI.onPiPWindowResized((event, bounds) => {
          console.log('PIP window resized:', bounds);
        });
      }
      
      // Auto-focus first button for TV remote navigation
      setTimeout(() => {
        const firstButton = document.querySelector('.dashboard-button');
        if (firstButton) {
          firstButton.focus();
          console.log('TV Remote Navigation: First button auto-focused');
        }
      }, 500);
    });

    // ========== SYSTEM CONTROLS MODAL ==========
    function openSystemControls() {
      const modal = document.getElementById('systemModal');
      modal.classList.add('active');
      
      // Sync slider values with modal
      document.getElementById('volumeSliderModal').value = currentVolume;
      document.getElementById('volumeValueModal').textContent = currentVolume + '%';
      document.getElementById('lightSliderModal').value = currentLightLevel;
      document.getElementById('lightValueModal').textContent = currentLightLevel + '%';
    }

    function closeSystemControls() {
      const modal = document.getElementById('systemModal');
      modal.classList.remove('active');
    }

    // Close modal with ESC key
    document.addEventListener('keydown', (e) => {
      if (e.key === 'Escape') {
        const modal = document.getElementById('systemModal');
        if (modal.classList.contains('active')) {
          closeSystemControls();
        }
      }
    });

    // ========== PIP WINDOW MANAGEMENT ==========
    function getCornerBounds(corner) {
      const width = 480;
      const height = 270;
      const margin = 16;
      const sw = window.screen.availWidth;
      const sh = window.screen.availHeight;
      const positions = {
        tl: { left: margin, top: margin },
        tr: { left: sw - width - margin, top: margin },
        bl: { left: margin, top: sh - height - margin },
        br: { left: sw - width - margin, top: sh - height - margin }
      };
      const pos = positions.br;
      return { width, height, left: pos.left, top: pos.top };
    }

    function browserSnapPiP(corner) {
      if (pipWindow && !pipWindow.closed) {
        const width = 480;
        const height = 270;
        const margin = 16;
        const sw = window.screen.availWidth;
        const sh = window.screen.availHeight;
        const map = {
          tl: { left: margin, top: margin },
          tr: { left: sw - width - margin, top: margin },
          bl: { left: margin, top: sh - height - margin },
          br: { left: sw - width - margin, top: sh - height - margin }
        };
        const pos = map[corner] || map.br;
        try {
          pipWindow.resizeTo(width, height);
          pipWindow.moveTo(pos.left, pos.top);
          pipWindow.focus();
        } catch (e) {
          console.warn('[PiP] Browser snap failed:', e);
        }
      }
    }

    function toggleMiniGeneric() {
      if (isElectron && window.electronAPI) {
        window.electronAPI.togglePiPMini();
      } else if (pipWindow && !pipWindow.closed) {
        // Toggle between mini and near-fullscreen popup
        try {
          const sw = window.screen.availWidth;
          const sh = window.screen.availHeight;
          if (Math.abs(pipWindow.outerWidth - 480) < 20 && Math.abs(pipWindow.outerHeight - 270) < 20) {
            pipWindow.moveTo(0, 0);
            pipWindow.resizeTo(sw, sh);
          } else {
            browserSnapPiP('br');
          }
        } catch (e) {
          console.warn('[PiP] Browser toggle failed:', e);
        }
      }
    }

    async function showPiPPreview(serviceName, url) {
      currentPiPService = serviceName;
      
      console.log(`[PiP] Opening ${serviceName} with URL: ${url}`);
      console.log(`[PiP] isElectron: ${isElectron}, electronAPI: ${!!window.electronAPI}`);
      
      // Hide placeholder, show active PiP
      document.getElementById('pipPlaceholder').style.display = 'none';
      document.getElementById('pipActive').style.display = 'flex';
      document.getElementById('pipServiceName').textContent = serviceName;
      document.getElementById('pipTitle').textContent = `Preview: ${serviceName}`;
      document.getElementById('pipCloseBtn').style.display = 'block';
      
      // Check if running in Electron or Browser
      if (isElectron && window.electronAPI) {
        // Electron Mode - Use separate BrowserWindow positioned over preview box
        console.log(`[PiP] Electron mode - creating positioned window`);
        
        // Check if this is a DRM service
        const isDRMService = ['netflix', 'amazon', 'appletv', 'youtube'].includes(serviceName.toLowerCase());
        
        if (isDRMService) {
          // Show warning about Widevine
          console.log(`[PiP] DRM service detected - Widevine not available`);
          document.querySelector('.pip-zone-hint').textContent = `Widevine not available - Toggle PIP OFF for browser mode`;
          showStatus(`Widevine not available - Use Browser Mode for ${serviceName}`, 'info');
        }
        
        // Ensure best-fitting aspect before sizing
        applyAutoPiPAspect();

        // Get viewport bounds for PIP window
        const pipViewport = document.getElementById('pipViewport');
        if (!pipViewport) {
          console.error('[PiP] Viewport element not found!');
          showStatus('Preview box not found', 'error');
          return;
        }
        
        const rect = pipViewport.getBoundingClientRect();
        
        const bounds = {
          width: Math.floor(rect.width),
          height: Math.floor(rect.height),
          x: Math.floor(rect.left),
          y: Math.floor(rect.top)
        };
        
        console.log(`[PiP] Creating window at bounds:`, bounds);
        
        // Create PIP window via Electron IPC
        try {
          await window.electronAPI.createPiPWindow(url, serviceName, bounds);
          
          // Show success message
          const successMessage = isDRMService 
            ? `${serviceName} opened - Widevine may not be available`
            : `${serviceName} preview opened`;
          document.querySelector('.pip-zone-hint').textContent = successMessage;
          showStatus(successMessage, 'success');
          
          console.log(`[PiP] Preview window created successfully`);
        } catch (error) {
          console.error('[PiP] Failed to create preview window:', error);
          showStatus(`Failed to open ${serviceName} preview`, 'error');
          document.querySelector('.pip-zone-hint').textContent = `Failed to open ${serviceName} preview`;
          document.querySelector('.pip-zone-hint').style.display = 'block';
        }
      } else {
        // Browser Mode - Open mini popup styled like our Electron mini-player
        console.log(`[PiP] Browser mode - opening mini popup`);

        // Show message about Widevine
        const isDRMService = ['netflix', 'amazon', 'appletv', 'youtube'].includes(serviceName.toLowerCase());
        const message = isDRMService 
          ? `Opening Browser - Widevine Support not enabled in Electron`
          : `${serviceName} opened in browser`;

        const b = getCornerBounds('br');
        const features = `popup=1,toolbar=0,location=0,menubar=0,status=0,scrollbars=0,resizable=1,width=${b.width},height=${b.height},left=${b.left},top=${b.top}`;
        pipWindow = window.open(url, serviceName + '_mini', features);

        if (pipWindow) {
          // Try to ensure size/position
          try {
            pipWindow.resizeTo(b.width, b.height);
            pipWindow.moveTo(b.left, b.top);
          } catch {}

          document.querySelector('.pip-zone-hint').textContent = message;
          showStatus(message, isDRMService ? 'info' : 'success');
        } else {
          document.querySelector('.pip-zone-hint').textContent = `Pop-up blocked. Allow pop-ups to preview ${serviceName}`;
          showStatus(`Pop-up blocked. Allow pop-ups to preview ${serviceName}`, 'error');
        }
      }
    }

    async function closePiP() {
      // Close PIP window
      if (isElectron && window.electronAPI) {
        // Close via Electron IPC
        try {
          await window.electronAPI.closePiPWindow();
          console.log('[PiP] Preview window closed');
        } catch (error) {
          console.error('[PiP] Failed to close preview window:', error);
        }
      } else if (pipWindow && !pipWindow.closed) {
        // Close browser tab
        pipWindow.close();
      }
      
      // Reset PiP UI
      document.getElementById('pipPlaceholder').style.display = 'flex';
      document.getElementById('pipActive').style.display = 'none';
      document.getElementById('pipTitle').textContent = 'Preview';
      document.getElementById('pipCloseBtn').style.display = 'none';
      document.getElementById('pipExpandBtn').style.display = 'none';
      document.querySelector('.pip-zone-hint').textContent = 'Service window will appear here';
      
      pipWindow = null;
      currentPiPService = null;
    }

    async function expandPiP() {
      if (currentPiPService) {
        if (isElectron && window.electronAPI) {
          // Expand PIP window to full screen via Electron IPC
          try {
            await window.electronAPI.expandPiPWindow();
            showStatus(`${currentPiPService} expanded to full screen`, 'success');
            
            // Reset PiP UI after expansion
            closePiP();
          } catch (error) {
            console.error('[PiP] Failed to expand preview window:', error);
            showStatus(`Failed to expand ${currentPiPService}`, 'error');
          }
        } else {
          // Browser mode - just close and let user interact with tab
          showStatus(`${currentPiPService} is in browser tab - interact with it directly`, 'info');
          closePiP();
        }
      }
    }

    async function repositionPiP() {
      if (currentPiPService) {
        if (isElectron && window.electronAPI) {
          // Re-evaluate aspect and get new bounds
          applyAutoPiPAspect();
          const pipViewport = document.getElementById('pipViewport');
          const rect = pipViewport.getBoundingClientRect();
          
          const bounds = {
            width: Math.floor(rect.width),
            height: Math.floor(rect.height),
            x: Math.floor(rect.left),
            y: Math.floor(rect.top)
          };
          
          // Reposition PIP window via Electron IPC
          try {
            await window.electronAPI.repositionPiPWindow(bounds);
            showStatus(`${currentPiPService} window repositioned`, 'success');
            console.log(`[PiP] Window repositioned: ${currentPiPService}`);
          } catch (error) {
            console.error('[PiP] Failed to reposition preview window:', error);
            showStatus(`Failed to reposition ${currentPiPService}`, 'error');
          }
        } else {
          showStatus('Reposition only available in Electron mode', 'info');
        }
      }
    }

    // Global hotkeys for mini controls (Electron and Browser modes)
    window.addEventListener('keydown', (e) => {
      if (!(e.ctrlKey && e.shiftKey)) return;
      const key = e.key.toLowerCase();
      if (key === 'm') {
        e.preventDefault();
        toggleMiniGeneric();
      }
      if (['1','2','3','4'].includes(key)) {
        e.preventDefault();
        const map = { '1': 'tl', '2': 'tr', '3': 'bl', '4': 'br' };
        const corner = map[key];
        if (isElectron && window.electronAPI) {
          window.electronAPI.snapPiPCorner(corner);
        } else {
          browserSnapPiP(corner);
        }
      }
    });


    // Choose between 16:9 and 2.35:1 automatically based on available space
    function applyAutoPiPAspect() {
      const zone = document.getElementById('pipZone');
      const viewport = document.getElementById('pipViewport');
      if (!zone || !viewport) return;

      if (pipAspectMode === '16x9') {
        viewport.style.setProperty('--pip-aspect', '16 / 9');
        return;
      }
      if (pipAspectMode === '2351') {
        viewport.style.setProperty('--pip-aspect', '2.35 / 1');
        return;
      }

      // Auto mode: pick the aspect that yields the largest area without exceeding height
      const availableWidth = zone.clientWidth;
      const availableHeight = zone.clientHeight;

      const height16by9 = availableWidth * (9 / 16);
      const height2351 = availableWidth / 2.35; // 2.35:1 cinema scope

      const fits16 = height16by9 <= availableHeight;
      const fits235 = height2351 <= availableHeight;

      // Prefer the one that uses more of the available height; if both overflow, fall back to 16:9
      let chosen = '16 / 9';
      if (fits16 && fits235) {
        chosen = (availableHeight - height2351) < (availableHeight - height16by9) ? '2.35 / 1' : '16 / 9';
      } else if (!fits16 && fits235) {
        chosen = '2.35 / 1';
      } else if (fits16 && !fits235) {
        chosen = '16 / 9';
      } else {
        // both too tall at full width; still set 16:9 and let CSS scale
        chosen = '16 / 9';
      }

      viewport.style.setProperty('--pip-aspect', chosen);
    }

    // Re-evaluate aspect on window resize/orientation changes
    window.addEventListener('resize', () => {
      applyAutoPiPAspect();
      // Reposition PIP window if active and in Electron mode
      if (currentPiPService && isElectron && window.electronAPI) {
        repositionPiP();
      }
    });



  </script>

  <!-- Responsive Navigation & Utilities -->
  <script src="responsive.js"></script>

</body>
</html>
